<!DOCTYPE html>
<html lang="{{lang}}">
<head>
    <meta charset="utf-8">
    <title>{{t.title}} - မောင်သုည</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="refresh" content="120">
    <!-- မြန်မာဖောင့်အတွက် Padauk ကို ထည့်သွင်းထားသည် -->
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
:root{
    --bg-dark: #0f172a; --fg-dark: #f1f5f9; --card-dark: #1e293b; --bd-dark: #334155; --primary-dark: #3b82f6;
    --bg-light: #f8fafc; --fg-light: #1e293b; --card-light: #ffffff; --bd-light: #e2e8f0; --primary-light: #2563eb;
    --ok: #10b981; --bad: #ef4444; --unknown: #f59e0b; --expired: #8b5cf6;
    --success: #06d6a0; --delete-btn: #ef4444; --logout-btn: #f97316;
    --font: 'Padauk', sans-serif; --radius: 0.5rem;
    --switch-bg-off: var(--bd); /* မီးပိတ်ထားသော switch background */
    --switch-bg-on: var(--ok); /* မီးဖွင့်ထားသော switch background */
}
body { 
    font-family: var(--font); background: var(--bg-light); color: var(--fg-light); 
    padding: 1rem; transition: background-color 0.3s, color 0.3s;
}
@media (prefers-color-scheme: dark) {
    body { background: var(--bg-dark); color: var(--fg-dark); }
    :root { 
        --bg: var(--bg-dark); --fg: var(--fg-dark); --card: var(--card-dark); --bd: var(--bd-dark); --primary: var(--primary-dark);
        --switch-bg-off: var(--bd-dark);
    }
}
.dark-mode-manual {
    --bg: var(--bg-dark); --fg: var(--fg-dark); --card: var(--card-dark); --bd: var(--bd-dark); --primary: var(--primary-dark);
    --switch-bg-off: var(--bd-dark);
}
.light-mode-manual {
    --bg: var(--bg-light); --fg: var(--fg-light); --card: var(--card-light); --bd: var(--bd-light); --primary: var(--primary-light);
    --switch-bg-off: var(--bd-light);
}

/* Base Styles */
.container { 
    max-width: 1400px; margin: 0 auto; padding: 0 1rem; 
}
.header {
    display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;
}
.logo-container {
    display: flex; align-items: center; gap: 10px;
}
.logo-img {
    height: 40px; width: 40px; border-radius: 50%; object-fit: cover;
}
.title {
    font-size: 1.5rem; font-weight: 700; color: var(--primary);
}
.controls {
    display: flex; gap: 0.5rem; align-items: center;
}
.btn {
    padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 700;
    cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
    border: none;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #3c65b5; }
.btn-danger { background: var(--delete-btn); color: white; }
.btn-danger:hover { background: #c23333; }
.btn-warning { background: var(--logout-btn); color: white; }
.btn-warning:hover { background: #c45d11; }
.btn-link { background: none; color: var(--fg); padding: 0.5rem; }
.btn-link:hover { background: var(--bd); }
.icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

/* Dashboard Cards */
.card-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;
}
.stat-card {
    background: var(--card); border-radius: var(--radius); padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--bd);
}
.stat-card h3 { font-size: 1.125rem; font-weight: 600; color: var(--fg); }
.stat-card p { font-size: 2.25rem; font-weight: 700; margin-top: 0.5rem; color: var(--primary); }
.stat-icon { font-size: 1.5rem; margin-right: 0.75rem; color: var(--primary); }

/* User Table */
.data-section { margin-top: 2rem; }
.section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--fg); }
.table-responsive { overflow-x: auto; }
.user-table {
    width: 100%; border-collapse: collapse; background: var(--card); border-radius: var(--radius); overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
.user-table th, .user-table td {
    padding: 1rem; text-align: left; border-bottom: 1px solid var(--bd);
}
.user-table th {
    background: var(--bd); font-weight: 700; text-transform: uppercase; font-size: 0.75rem;
    color: var(--fg);
}
.user-table tr:hover { background: rgba(var(--primary-light-rgb), 0.1); }
.status-dot {
    display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px;
}
.status-online { background-color: var(--ok); }
.status-offline { background-color: var(--bad); }
.status-expired { background-color: var(--expired); }
.status-suspended { background-color: var(--bad); } /* Suspended user အတွက် */
.status-active { background-color: var(--ok); } /* Active user အတွက် */

/* Modal & Forms */
.modal {
    display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.4);
}
.modal-content {
    background-color: var(--card); margin: 5% auto; padding: 20px; border-radius: var(--radius);
    width: 90%; max-width: 500px; position: relative; border: 1px solid var(--bd);
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.close-btn {
    color: var(--fg); float: right; font-size: 28px; font-weight: bold;
}
.close-btn:hover, .close-btn:focus {
    color: var(--delete-btn); text-decoration: none; cursor: pointer;
}
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
.form-group input[type="text"], .form-group input[type="password"], .form-group input[type="number"], .form-group input[type="date"] {
    width: 100%; padding: 0.75rem; border: 1px solid var(--bd); border-radius: var(--radius);
    background: var(--bg); color: var(--fg);
}
.form-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--primary); text-align: center; }

/* Alerts and Messages */
.alert {
    padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; font-weight: 600;
}
.alert-success { background-color: var(--ok); color: white; }
.alert-error { background-color: var(--bad); color: white; }
.alert-info { background-color: var(--primary); color: white; }

/* Custom Toggle Switch (X-UI Style) */
.switch-container {
    display: flex; align-items: center; justify-content: center;
}
.switch {
    position: relative;
    display: inline-block;
    width: 45px; /* ပိုသေးငယ်အောင် ပြုလုပ်သည် */
    height: 25px;
}

.switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--switch-bg-off);
    transition: 0.4s;
    border-radius: 25px; /* မျဉ်းကွေးပုံစံ */
}

.slider:before {
    position: absolute;
    content: "";
    height: 17px;
    width: 17px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--switch-bg-on);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--switch-bg-on);
}

input:checked + .slider:before {
    transform: translateX(20px);
}
    </style>
</head>
<body class="light-mode-manual">
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="logo-container">
                <img src="{{logo_url}}" alt="ZIVPN Logo" class="logo-img">
                <h1 class="title">{{t.title}}</h1>
            </div>
            <div class="controls">
                <button id="themeToggle" class="btn btn-link icon-btn" onclick="toggleTheme()">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
                <button class="btn btn-warning" onclick="window.location.href='{{ url_for('logout') }}'">
                    <i class="fas fa-sign-out-alt"></i> {{t.logout}}
                </button>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="messageArea"></div>

        <!-- Dashboard Stats Grid -->
        <div class="card-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
        </div>

        <!-- User Management Section -->
        <div class="data-section">
            <h2 class="section-title">
                <i class="fas fa-users"></i> {{t.total_users}}
                <button class="btn btn-primary" onclick="showModal('addUserModal')">
                    <i class="fas fa-plus"></i> {{t.add_user}}
                </button>
                <button class="btn btn-primary" onclick="loadUsers()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="btn btn-link" onclick="showModal('changePasswordModal')">
                    <i class="fas fa-key"></i> Admin Password
                </button>
            </h2>
            
            <!-- User Table -->
            <div class="table-responsive">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>{{t.username}}</th>
                            <th>{{t.status}}</th> <!-- New: Status Column -->
                            <th>{{t.active_users}}</th>
                            <th>{{t.data_limit}}</th> <!-- New: Data Limit Column -->
                            <th>{{t.bandwidth_used}}</th>
                            <th>{{t.expire_date}}</th> <!-- New: Expiration Date Column -->
                            <th>{{t.last_online}}</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="8" style="text-align: center;">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Section (unchanged) -->
        <div class="data-section">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Report</h2>
            <div class="card-grid" style="grid-template-columns: 1fr;">
                <div class="stat-card" style="padding: 1rem;">
                    <div class="flex items-center space-x-4">
                        <select id="reportType" class="form-group" style="padding: 0.75rem; border-radius: var(--radius); border: 1px solid var(--bd); background: var(--bg); color: var(--fg);">
                            <option value="monthly_traffic">{{t.monthly_traffic}}</option>
                            <option value="revenue">{{t.revenue_report}}</option>
                        </select>
                        <input type="date" id="fromDate" placeholder="From (YYYY-MM-DD)" class="form-group" style="flex: 1;">
                        <input type="date" id="toDate" placeholder="To (YYYY-MM-DD)" class="form-group" style="flex: 1;">
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-file-export"></i> Generate
                        </button>
                    </div>
                </div>
            </div>
            <div id="reportResults" class="data-section"></div>
        </div>

        <!-- Footer -->
        <footer style="text-align: center; padding: 2rem 0; color: var(--bd);">
            &copy; 2024 ZIVPN Enterprise Panel | {{t.contact}}: [Your Contact Here]
        </footer>

    </div>

    <!-- Modal for Add User -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addUserModal')">&times;</span>
            <h3 class="form-title">{{t.add_user}}</h3>
            <div id="addUserMessageArea"></div>
            <div class="form-group">
                <label for="newUsername">{{t.username}} (Customer Email/Name)</label>
                <!-- ဝယ်သူရဲ့ Email နေရာမှာ ကြိုက်ရာ ရေးနိုင်ရန် -->
                <input type="text" id="newUsername" required placeholder="customer-001 or customer@mail.com">
            </div>
            <!-- Password Field ကို ဖယ်ရှားလိုက်သည် (Backend က UUID ထုတ်ပေးမည်) -->
            <div class="form-group">
                <label for="dataLimit">{{t.data_limit}} (MB) <i class="fas fa-info-circle" title="0 = Unlimited"></i></label>
                <!-- 0 ထားရင် Unlimited -->
                <input type="number" id="dataLimit" min="0" value="0" placeholder="0 = Unlimited">
            </div>
            <div class="form-group">
                <label for="expireDate">{{t.expire_date}}</label>
                <!-- Calendar (ပြက္ခဒိန်) ရွေးချယ်နိုင်သော Input -->
                <input type="date" id="expireDate">
            </div>
            <button class="btn btn-primary w-full" onclick="addUser()">
                <i class="fas fa-user-plus"></i> {{t.add_user}}
            </button>
        </div>
    </div>

    <!-- Modal for Change Admin Password -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('changePasswordModal')">&times;</span>
            <h3 class="form-title">Change Admin Password</h3>
            <div id="changePassMessageArea"></div>
            <div class="form-group">
                <label for="newAdminPassword">New Password</label>
                <input type="password" id="newAdminPassword" required>
            </div>
            <button class="btn btn-primary w-full" onclick="changeAdminPassword()">
                <i class="fas fa-save"></i> Save New Password
            </button>
        </div>
    </div>

    <!-- Modal for Delete User Confirmation -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('deleteUserModal')">&times;</span>
            <h3 class="form-title">Confirm Deletion</h3>
            <p id="deleteUserName"></p>
            <div class="flex gap-4 mt-4">
                <button class="btn btn-danger flex-1" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Yes, Delete
                </button>
                <button class="btn btn-primary flex-1" onclick="closeModal('deleteUserModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for User Details (to show generated password) -->
    <div id="userDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('userDetailsModal')">&times;</span>
            <h3 class="form-title">User Created Successfully!</h3>
            <p class="text-lg font-semibold mb-2" id="detailUsername"></p>
            <div class="form-group">
                <label>Generated Password (UUID):</label>
                <div class="flex items-center">
                    <input type="text" id="detailPassword" readonly class="flex-grow mr-2">
                    <button class="btn btn-primary" onclick="copyToClipboard('detailPassword', this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
            <button class="btn btn-primary w-full mt-4" onclick="closeModal('userDetailsModal')">
                Close
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables and constants
        const t = {{t|tojson}};
        const STATS_GRID = document.getElementById('statsGrid');
        const USER_TABLE_BODY = document.getElementById('userTableBody');
        const MESSAGE_AREA = document.getElementById('messageArea');

        // --- Utility Functions ---

        /** Displays a temporary message (success or error) */
        function showMessage(type, message) {
            MESSAGE_AREA.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => MESSAGE_AREA.innerHTML = '', 5000);
        }

        /** Shows a modal window */
        function showModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        /** Hides a modal window */
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        /** Converts bytes to a readable format (KB, MB, GB) */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /** Copies text from an input field to the clipboard */
        function copyToClipboard(inputId, button) {
            const copyText = document.getElementById(inputId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            try {
                document.execCommand('copy');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                showMessage('error', 'Copying failed. Please copy manually.');
            }
        }
        
        // --- Theme Toggling ---
        function getTheme() {
            return localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        }

        function setTheme(theme) {
            document.body.className = theme === 'dark' ? 'dark-mode-manual' : 'light-mode-manual';
            document.getElementById('themeIcon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = getTheme();
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        }

        // Apply theme on load
        window.onload = () => {
            setTheme(getTheme());
            loadStats();
            loadUsers();
        };

        // --- Core Functions: Dashboard Stats ---

        /** Loads and displays the dashboard statistics */
        function loadStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    if (data.err) return showMessage('error', data.err);

                    STATS_GRID.innerHTML = `
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-users"></i> ${t.total_users}</h3>
                            <p>${data.total_users}</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-circle-notch status-online"></i> ${t.active_users} (Online)</h3>
                            <p>${data.active_users}</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-check-circle status-active"></i> ${t.current_status} (Active)</h3>
                            <p>${data.active_status_users}</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-calendar-times status-expired"></i> ${t.expired_users}</h3>
                            <p>${data.expired_users}</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-sort-amount-up-alt"></i> ${t.bandwidth_used}</h3>
                            <p>${formatBytes(data.total_traffic_used)}</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="stat-icon fas fa-user-plus"></i> Users (Last 24H)</h3>
                            <p>${data.recent_users}</p>
                        </div>
                    `;
                })
                .catch(e => {
                    showMessage('error', 'Error loading stats: ' + e.message);
                });
        }

        // --- Core Functions: User Management ---

        /** * Toggles the status of a user (Active/Suspended).
         * This function is triggered by the new On/Off switch.
         */
        function toggleUserStatus(username) {
            // Confirm the action using a custom modal/alert if needed, but for simplicity, we proceed directly.
            // In a real app, use a custom modal for confirmation instead of window.confirm.

            fetch('/api/user/toggle_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    showMessage('success', data.message);
                    loadUsers(); // Refresh the list to show the new status
                } else {
                    showMessage('error', data.err || 'Failed to toggle user status.');
                    loadUsers(); // Refresh to revert the toggle state on error
                }
            })
            .catch(e => {
                showMessage('error', 'API error when toggling status: ' + e.message);
                loadUsers(); // Refresh to revert the toggle state on error
            });
        }

        /** Loads and renders the user list table */
        function loadUsers() {
            USER_TABLE_BODY.innerHTML = `<tr><td colspan="8" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading users...</td></tr>`;

            fetch('/api/users')
                .then(r => r.json())
                .then(data => {
                    if (data.err) return showMessage('error', data.err);

                    if (data.length === 0) {
                        USER_TABLE_BODY.innerHTML = `<tr><td colspan="8" style="text-align: center;">No users found.</td></tr>`;
                        return;
                    }

                    USER_TABLE_BODY.innerHTML = data.map(user => {
                        // 1. Online Status Check
                        const isOnline = user.online_count > 0;
                        const statusDotClass = isOnline ? 'status-online' : 'status-offline';
                        const onlineText = isOnline ? 'Online' : 'Offline';

                        // 2. Status Check (Active/Suspended)
                        const isActive = user.status === 'active';
                        const statusBadge = isActive 
                            ? `<span class="status-dot status-active"></span> Active`
                            : `<span class="status-dot status-suspended"></span> Suspended`;
                        
                        // 3. Data Limit and Usage Calculation
                        const totalTraffic = user.total_traffic;
                        const dataLimitMB = user.data_limit; // MB
                        const dataLimitBytes = dataLimitMB * 1024 * 1024;

                        let dataUsageDisplay = formatBytes(totalTraffic);
                        let limitDisplay = t.unlimited;
                        let usageColor = '';

                        if (dataLimitMB > 0) {
                            limitDisplay = formatBytes(dataLimitBytes);
                            // Calculate percentage used
                            const percentageUsed = (totalTraffic / dataLimitBytes) * 100;
                            dataUsageDisplay = `${dataUsageDisplay} / ${limitDisplay}`;

                            if (totalTraffic >= dataLimitBytes) {
                                usageColor = 'color: var(--delete-btn); font-weight: 700;'; // Over limit
                            } else if (percentageUsed > 80) {
                                usageColor = 'color: var(--unknown);'; // Near limit
                            }
                        }

                        // 4. Expiration Check
                        let expireDisplay = user.expires_at || 'N/A';
                        let expireColor = '';
                        let isExpired = user.is_expired; // Backend ကနေ တွက်ပြီးသား

                        if (isExpired) {
                            expireColor = 'color: var(--expired); font-weight: 700;';
                        }
                        
                        // 5. Toggle Switch HTML
                        const toggleSwitchHtml = `
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleUserStatus('${user.username}')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        `;


                        return `
                            <tr>
                                <td style="font-weight: 700;">${user.username}</td>
                                <td>${toggleSwitchHtml}</td> <!-- Status Toggle -->
                                <td>
                                    <span class="status-dot ${statusDotClass}"></span> 
                                    ${user.online_count} (${onlineText})
                                </td>
                                <td style="${usageColor}">${dataUsageDisplay}</td>
                                <td>${limitDisplay}</td>
                                <td style="${expireColor}">${expireDisplay} ${isExpired ? '(Expired)' : ''}</td>
                                <td>${user.last_online_str}</td>
                                <td>
                                    <button class="btn btn-danger icon-btn" title="${t.del_user}" onclick="confirmDeleteUser('${user.username}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(e => {
                    USER_TABLE_BODY.innerHTML = `<tr><td colspan="8" style="text-align: center;">Error: ${e.message}. Check browser console.</td></tr>`;
                    showMessage('error', 'Error loading user list.');
                });
        }

        /** Handles adding a new user */
        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const dataLimit = document.getElementById('dataLimit').value.trim();
            const expireDate = document.getElementById('expireDate').value.trim();
            const messageArea = document.getElementById('addUserMessageArea');
            messageArea.innerHTML = '';

            if (!username) {
                messageArea.innerHTML = `<div class="alert alert-error">${t.username_required}</div>`;
                return;
            }

            // Show loading
            messageArea.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Adding user...</div>`;

            fetch('/api/user/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username,
                    data_limit_mb: dataLimit, // 0 = unlimited
                    expire_date: expireDate || null // null if empty
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    closeModal('addUserModal');
                    // Show success with the generated password (UUID)
                    document.getElementById('detailUsername').textContent = `Username: ${data.username}`;
                    document.getElementById('detailPassword').value = data.password;
                    showModal('userDetailsModal'); 
                    loadStats();
                    loadUsers();
                } else {
                    messageArea.innerHTML = `<div class="alert alert-error">${data.err || 'An unknown error occurred.'}</div>`;
                }
            })
            .catch(e => {
                messageArea.innerHTML = `<div class="alert alert-error">API Error: ${e.message}</div>`;
            });
        }
        
        /** Shows confirmation modal for user deletion */
        function confirmDeleteUser(username) {
            const deleteUserNameElement = document.getElementById('deleteUserName');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            deleteUserNameElement.innerHTML = `Are you sure you want to delete user: <strong>${username}</strong>?`;
            
            // Remove previous event listeners
            const newConfirmDeleteBtn = confirmDeleteBtn.cloneNode(true);
            confirmDeleteBtn.parentNode.replaceChild(newConfirmDeleteBtn, confirmDeleteBtn);
            
            // Add new event listener with the specific username
            newConfirmDeleteBtn.addEventListener('click', () => {
                deleteUser(username);
            });

            showModal('deleteUserModal');
        }

        /** Deletes a user */
        function deleteUser(username) {
            closeModal('deleteUserModal');
            showMessage('info', `Deleting user ${username}...`);

            fetch('/api/user/del', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: username })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    showMessage('success', data.message);
                    loadStats();
                    loadUsers();
                } else {
                    showMessage('error', data.err || 'Failed to delete user.');
                }
            })
            .catch(e => {
                showMessage('error', 'API Error: ' + e.message);
            });
        }

        /** Change Admin Password */
        function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            const messageArea = document.getElementById('changePassMessageArea');
            messageArea.innerHTML = '';

            if (!newPassword) {
                messageArea.innerHTML = `<div class="alert alert-error">New password is required.</div>`;
                return;
            }

            messageArea.innerHTML = `<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Updating password...</div>`;

            fetch('/api/admin/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_password: newPassword })
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    messageArea.innerHTML = `<div class="alert alert-success">${data.message}. Please remember your new password.</div>`;
                    document.getElementById('newAdminPassword').value = '';
                    setTimeout(() => closeModal('changePasswordModal'), 3000);
                } else {
                    messageArea.innerHTML = `<div class="alert alert-error">${data.err || 'Failed to change password.'}</div>`;
                }
            })
            .catch(e => {
                messageArea.innerHTML = `<div class="alert alert-error">API Error: ${e.message}</div>`;
            });
        }
        
        // Report Generation Function (unchanged)
        function generateReport() {
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const type = document.getElementById('reportType').value;
            const reportResults = document.getElementById('reportResults');

            if (!from || !to) {
                 // **IMPORTANT**: Removed window.alert() and replaced with custom message
                showMessage('error', t.report_range);
                return;
            }

            reportResults.innerHTML = '<div class="form-card" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Generating Report...</div>';

            fetch(`/api/reports?from=${from}&to=${to}&type=${type}`)
                .then(r => r.json())
                .then(data => {
                    reportResults.innerHTML = `
                        <div class="stat-card">
                            <h3 class="form-title">${type.toUpperCase()} Report (${from} to ${to})</h3>
                            <pre style="background: var(--bg); padding: 15px; border-radius: var(--radius); border: 1px solid var(--bd); overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                })
                .catch(e => {
                    reportResults.innerHTML = '<div class="alert alert-error">Error loading report: ' + e.message + '</div>';
                });
        }


        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['addUserModal', 'changePasswordModal', 'deleteUserModal', 'userDetailsModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) {
                    closeModal(id);
                }
            });
        }
    </script>
</body>
</html>

